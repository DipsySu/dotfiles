# =================================================================
# Custom Functions / è‡ªå®šä¹‰å‡½æ•°
# =================================================================

# =================================================================
# 5. è‡ªå®šä¹‰ AWS å‡½æ•° (å¸¦å‡­è¯è¾“å‡ºç‰ˆ)
# =================================================================

# --- è¾…åŠ©å‡½æ•°ï¼šæ‰“å°å‡­è¯ (å¸¦é¢œè‰²é«˜äº®) ---
function print_aws_creds() {
    echo ""
    echo -e "\033[0;33mğŸ”‘ Current Session Credentials:\033[0m"
    echo "---------------------------------------------------"
    echo -e "AWS_ACCESS_KEY_ID     : \033[0;32m$AWS_ACCESS_KEY_ID\033[0m"
    echo -e "AWS_SECRET_ACCESS_KEY : \033[0;32m$AWS_SECRET_ACCESS_KEY\033[0m"
    # å¦‚æœæœ‰ Session Token ä¹Ÿæ‰“å°å‡ºæ¥ï¼Œæ²¡æœ‰å°±ä¸æ‰“å°
    if [ -n "$AWS_SESSION_TOKEN" ]; then
        echo -e "AWS_SESSION_TOKEN     : \033[0;32m$AWS_SESSION_TOKEN\033[0m"
    fi
    echo "---------------------------------------------------"
}

function aws-cn() {
    if ! aws sts get-caller-identity --profile aws-cn > /dev/null 2>&1; then
        echo "âš ï¸  SSO Token expired. Launching browser login..."
        aws sso login --profile aws-cn
    fi

    export AWS_REGION="{{ .aws.cn_region }}"
    export AWS_DEFAULT_REGION="{{ .aws.cn_region }}"
    export AWS_PROFILE="aws-cn"

    echo "âœ… Switched to aws-cn environment!"
    
    # å¯¼å‡ºç¯å¢ƒå˜é‡
    eval $(aws configure export-credentials --profile aws-cn --format env)
    # æ‰“å°å‡­è¯
    print_aws_creds
}

function aws-sg() {
    export AWS_REGION="{{ .aws.sg_region }}"
    export AWS_PROFILE="aws-sg"
    
    if [ ! -d "$HOME/.aws-sg" ]; then
        mkdir -p "$HOME/.aws-sg"
    fi
    export USER_HOME="$HOME/.aws-sg"

    echo "Fetching CodeArtifact token..."
    export CODEARTIFACT_AUTH_TOKEN=$(aws --profile aws-sg codeartifact get-authorization-token --domain {{ .aws.codeartifact_domain }} --query authorizationToken --output text)
    
    echo "âœ… Switched to aws-sg environment!"

    # å¯¼å‡ºç¯å¢ƒå˜é‡
    eval $(aws configure export-credentials --profile aws-sg --format env)
    # æ‰“å°å‡­è¯
    print_aws_creds
}

# --- å®¶å±…è‡ªåŠ¨åŒ–è„šæœ¬å¼€å§‹ ---

# å®šä¹‰ Tailscale è·¯å¾„å˜é‡ (æ”¯æŒå¤šå¹³å°)
{{- if .home.tailscale_path }}
export TAILSCALE_EXE="{{ .home.tailscale_path }}"
{{- else }}
# è‡ªåŠ¨æ£€æµ‹ Tailscale è·¯å¾„
for ts_path in "/mnt/c/Program Files/Tailscale/tailscale.exe" "/usr/bin/tailscale" "/usr/local/bin/tailscale"; do
    if [ -f "$ts_path" ]; then
        export TAILSCALE_EXE="$ts_path"
        break
    fi
done
{{- end }}

# å†…éƒ¨ç§æœ‰å‡½æ•°ï¼šæ£€æŸ¥å¹¶ç¡®ä¿ Tailscale å·²è¿æ¥
_ensure_tailscale() {
    echo "--- æ£€æŸ¥ Tailscale çŠ¶æ€ ---"
    
    # 1. æ£€æŸ¥ tailscale.exe æ˜¯å¦èƒ½è”é€šåå°
    local status_output=$("$TAILSCALE_EXE" status 2>&1)
    
    if echo "$status_output" | grep -q "Tailscale is starting"; then
        echo "â³ Tailscale æ­£åœ¨å¯åŠ¨ä¸­ï¼Œè¯·ç¨å€™..."
        sleep 3
    fi

    # 2. å¦‚æœçŠ¶æ€ä¾ç„¶æ˜¯ NoState æˆ– NeedsLoginï¼Œè¯´æ˜éœ€è¦ Windows ç«¯å¹²é¢„
    if echo "$status_output" | grep -q "NoState\|Stopped"; then
        echo "âŒ [Error] Windows ç«¯çš„ Tailscale æœªå¯åŠ¨æˆ–å·²é€€å‡ºã€‚"
        echo "ğŸ’¡ è¯·æ‰‹åŠ¨ç‚¹å‡» Windows ä»»åŠ¡æ å³ä¸‹è§’çš„ Tailscale å›¾æ ‡è¿›è¡Œ Connectã€‚"
        return 1
    fi

    echo "âœ… [Connected] Tailscale éš§é“å°±ç»ªã€‚"
    return 0
}

# 1. å”¤é†’å‘½ä»¤
wake_home() {
    echo "--- è¿œç¨‹å”¤é†’æµç¨‹å¼€å§‹ [$(date '+%H:%M:%S')] ---"
    
    # 1. æ£€æŸ¥ç½‘ç»œ
    if _ensure_tailscale; then
        echo "   [$(date '+%H:%M:%S')] ğŸ”— ç½‘ç»œå°±ç»ªï¼Œå‡†å¤‡å‘èµ· SSH è¯·æ±‚..."
        
        # 2. æ‰§è¡Œå”¤é†’ (å¢åŠ  -q å‡å°‘æ— ç”¨æç¤ºï¼Œå¢åŠ  -t å¼ºåˆ¶åˆ†é…ç»ˆç«¯ä»¥å®æ—¶å›æ˜¾)
        # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨ sshï¼Œå®ƒä¼šå®æ—¶æ˜¾ç¤ºè¿œç¨‹è„šæœ¬é‡Œçš„ echo å†…å®¹
        ssh -t {{ .home.ssh_host }} "/root/wake_pc.sh"
        
        # 3. å”¤é†’åçš„è‡ªåŠ¨æ£€æµ‹ (æ–°å¢åŠŸèƒ½ï¼šè‡ªåŠ¨å¸®ä½  Ping)
        echo "   [$(date '+%H:%M:%S')] â±ï¸ è„šæœ¬æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æŒç»­æ¢æµ‹ç”µè„‘çŠ¶æ€..."
        echo "   (æŒ‰ Ctrl+C å¯ä»¥æå‰ç»“æŸæ¢æµ‹)"
        
        # å°è¯• Ping ä½ çš„ç”µè„‘ IPï¼ŒæˆåŠŸåˆ™é€€å‡º
        # é€»è¾‘ï¼šåœ¨ iStoreOS ä¸Šä»£ä¸º ping ç”µè„‘
        ssh {{ .home.ssh_host }} "ping -c 10 -i 1 {{ .home.pc_ip }}" | grep --line-buffered "from"
        
        echo "--- å”¤é†’æµç¨‹ç»“æŸ [$(date '+%H:%M:%S')] ---"
    fi
}

# 2. çº¯ SSH å‘½ä»¤
ssh_istore() {
    if _ensure_tailscale; then
        echo "æ­£åœ¨è¿æ¥ iStoreOS ç»ˆç«¯..."
        ssh {{ .home.ssh_host }}
    fi
}

sleep_home() {
    echo "--- è¿œç¨‹ä¼‘çœ æµç¨‹å¼€å§‹ [$(date '+%H:%M:%S')] ---"
    # å†…éƒ¨æ£€æŸ¥ Tailscale æ˜¯å¦å·²ç”±ä½ æ‰‹åŠ¨å¼€å¯
    if _ensure_tailscale; then
        echo "   [$(date '+%H:%M:%S')] ğŸ”— æ­£åœ¨é€šè¿‡ iStoreOS ä¸‹è¾¾ä¼‘çœ æŒ‡ä»¤..."
        ssh -t {{ .home.ssh_host }} "/root/sleep_pc.sh"
        echo "--- æµç¨‹ç»“æŸ ---"
    fi
}

# æŸ¥çœ‹å®¶ä¸­å¿ƒ PC çš„å®æ—¶ç¡¬ä»¶çŠ¶æ€
check_home() {
    # ç¡®ä¿ç½‘ç»œè¿æ¥
    if _ensure_tailscale; then
        echo "ğŸ“Š æ­£åœ¨ä» iStoreOS æŠ“å– PC å®æ—¶æ•°æ®..."
        # ä½¿ç”¨ -t ä¿æŒå½©è‰²è¾“å‡ºï¼Œ-q éšè— SSH ç™»å½•æç¤º
        ssh -t {{ .home.ssh_host }} "/root/check_pc.sh"
    fi
}

# --- å®¶å±…è‡ªåŠ¨åŒ–è„šæœ¬ç»“æŸ ---

function gpullall() {
    find . -maxdepth 1 -type d -print0 | xargs -0 -I {} sh -c 'cd "{}" && [ -d .git ] && echo "Pulling {}" && git pull'
}
function gscan() {
    echo ""
    # æ‰“å°è¡¨å¤´
    printf "\033[1;30m%-35s %-25s %s\033[0m\n" "ğŸ“¦ REPOSITORY" "ğŸŒ¿ BRANCH" "ğŸ“Š STATUS"
    echo "------------------------------------------------------------------------"

    # éå†å½“å‰ç›®å½•ä¸‹æ‰€æœ‰å­æ–‡ä»¶å¤¹
    for d in ./*/; do
        # åªè¦æ˜¯ git ä»“åº“
        if [ -d "$d/.git" ]; then
            repo_name=$(basename "$d")

            # è·å–å½“å‰åˆ†æ”¯å
            branch=$(git -C "$d" branch --show-current)

            # è·å–å½“å‰çŠ¶æ€ (æ˜¯å¦æœ‰æœªæäº¤çš„ä¿®æ”¹)
            # --porcelain è¾“å‡ºç©ºå­—ç¬¦ä¸²è¡¨ç¤ºå¹²å‡€ï¼Œå¦åˆ™è¡¨ç¤ºæœ‰ä¿®æ”¹
            if [ -z "$(git -C "$d" status --porcelain)" ]; then
                status_icon="âœ… Clean"
                status_color="\033[32m" # ç»¿è‰²
            else
                status_icon="âš ï¸  Modified"
                status_color="\033[31m" # çº¢è‰²
            fi

            # æ‰“å°æ ¼å¼åŒ–çš„ä¸€è¡Œ
            # %-35s è¡¨ç¤ºå·¦å¯¹é½å 35ä¸ªå­—ç¬¦å®½åº¦
            printf "\033[1;36m%-35s\033[0m \033[33m%-25s\033[0m ${status_color}%s\033[0m\n" "$repo_name" "$branch" "$status_icon"
        fi
    done
    echo ""
}
