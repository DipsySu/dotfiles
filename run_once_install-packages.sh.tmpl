#!/bin/bash
set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 日志函数
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# 检查网络连接
check_network() {
    log_info "检查网络连接..."
    if ! curl -s --head --max-time 10 https://github.com > /dev/null; then
        log_error "网络连接失败，请检查网络设置"
        exit 1
    fi
    log_info "网络连接正常"
}

# 检查必要工具
check_dependencies() {
    log_info "检查必要工具..."
    for cmd in curl git; do
        if ! command -v $cmd &> /dev/null; then
            log_error "$cmd 未安装，请先安装"
            exit 1
        fi
    done
    log_info "必要工具检查完成"
}

# 备份现有配置
backup_configs() {
    log_info "备份现有配置..."
    backup_dir="$HOME/.dotfiles_backup_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$backup_dir"
    
    for config in .zshrc .gitconfig .config/mise; do
        if [ -e "$HOME/$config" ]; then
            cp -r "$HOME/$config" "$backup_dir/" 2>/dev/null || true
            log_info "已备份 $config 到 $backup_dir"
        fi
    done
}

# 主要安装流程开始
log_info "开始 Dotfiles 初始化流程..."

# 确保 ~/.local/bin 在 PATH 中
if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
    export PATH="$HOME/.local/bin:$PATH"
    log_info "已添加 ~/.local/bin 到 PATH"
fi

# 执行检查
check_network
check_dependencies
backup_configs

# 1. Install Homebrew (Cross-platform)
if ! command -v brew &> /dev/null; then
    log_info "安装 Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # 多平台 Homebrew 路径检查
    {{- if eq .chezmoi.os "linux" }}
    for brew_path in "/home/linuxbrew/.linuxbrew/bin/brew" "/usr/local/bin/brew"; do
        if [ -f "$brew_path" ]; then
            eval "$($brew_path shellenv)"
            log_info "已设置 Homebrew 环境变量: $brew_path"
            break
        fi
    done
    {{- else if eq .chezmoi.os "darwin" }}
    for brew_path in "/opt/homebrew/bin/brew" "/usr/local/bin/brew"; do
        if [ -f "$brew_path" ]; then
            eval "$($brew_path shellenv)"
            log_info "已设置 Homebrew 环境变量: $brew_path"
            break
        fi
    done
    {{- end }}
else
    log_info "Homebrew 已安装"
fi


# 2. Bundle Install
if command -v brew &> /dev/null; then
    log_info "安装 Homebrew 软件包..."
    if brew bundle --file="{{ .chezmoi.sourceDir }}/Brewfile"; then
        log_info "Homebrew 软件包安装完成"
    else
        log_warn "部分 Homebrew 软件包安装失败，但继续执行"
    fi
else
    log_error "Homebrew 未找到，跳过软件包安装"
fi

# 3. Mise Install
if command -v mise &> /dev/null; then
    log_info "安装 Mise 运行时..."
    if mise install; then
        log_info "Mise 运行时安装完成"
    else
        log_warn "Mise 运行时安装失败，但继续执行"
    fi
else
    log_warn "Mise 未找到，跳过运行时安装"
fi

# 3.5. Ensure Zsh is installed (Pre-requisite for Oh My Zsh)
if ! command -v zsh &> /dev/null; then
    log_info "Zsh 未找到，正在安装..."
    {{ if eq .chezmoi.os "linux" }}
        # 尝试使用系统包管理器安装
        if command -v apt-get &> /dev/null; then
            log_info "检测到 apt-get，请求 sudo 权限安装 zsh..."
            sudo apt-get update && sudo apt-get install -y zsh
        else
            log_warn "未找到 apt-get，尝试使用 Homebrew 安装 zsh..."
            brew install zsh || log_error "Zsh 安装失败，请手动安装！"
        fi
    {{ else if eq .chezmoi.os "darwin" }}
        log_info "macOS: 使用 Homebrew 安装 zsh..."
        brew install zsh
    {{ end }}
else
    log_info "Zsh 已安装"
fi

# 4. 安装 Oh My Zsh (如果不存在)
# 使用 --unattended 避免安装过程中卡住询问是否切换 shell
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    log_info "安装 Oh My Zsh..."
    if sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended; then
        log_info "Oh My Zsh 安装完成"
    else
        log_error "Oh My Zsh 安装失败"
        exit 1
    fi
else
    log_info "Oh My Zsh 已安装"
fi

# 5. 安装 Zsh 插件 (自动克隆到 custom 目录)
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"

# zsh-autosuggestions
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-autosuggestions" ]; then
    log_info "安装 zsh-autosuggestions..."
    if git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM}/plugins/zsh-autosuggestions; then
        log_info "zsh-autosuggestions 安装完成"
    else
        log_warn "zsh-autosuggestions 安装失败"
    fi
else
    log_info "zsh-autosuggestions 已安装"
fi

# zsh-syntax-highlighting
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" ]; then
    log_info "安装 zsh-syntax-highlighting..."
    if git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM}/plugins/zsh-syntax-highlighting; then
        log_info "zsh-syntax-highlighting 安装完成"
    else
        log_warn "zsh-syntax-highlighting 安装失败"
    fi
else
    log_info "zsh-syntax-highlighting 已安装"
fi

log_info "Dotfiles 初始化完成！"
log_info "请运行 'source ~/.zshrc' 或重启终端来应用新配置"